# connexion mysql, my.cnf dans Administrateur pour auth
$server = "localhost"
$database = "api_prof_db"

$outputFileName = "output_creation_compte_profAD_$(Get-Date -Format 'yyyy-MM-dd_HH:mm').txt"

# fichier sortie avec les utilisatuer et leur mot de passe genere
$outputFileCreated = "C:\Users\Administrateur\Desktop\$outputFileName"

# fichier sortie avec les profs trouve dans la base de donne
$outputFileAD = "C:\Users\Administrateur\Desktop\prof_results.txt"

# check cmb de prof dans la table
$checkQuery = "SELECT COUNT(*) FROM prof;"

# auth comamnde sql
$mysqlCheckCommand = @"
mysql --defaults-file="C:\Users\Administrateur\my.cnf" -h $server -D $database -e "$checkQuery" -B > $outputFileAD
"@

# execute commande pr check
Invoke-Expression -Command $mysqlCheckCommand

# nb ligne dans table prof et ecris dans ouputFileAD
$count = Get-Content -Path $outputFileAD -TotalCount 1
$count = [int]$count

# si table est vide
if ($count -eq 0) {
    Write-Host "table prof vite, arret script"
    exit
}

# sfw prof 
$query = "SELECT idprof, prenomProf, nomProf, departement FROM prof;"


# commande auth
$mysqlCommand = @"
mysql --defaults-file="C:\Users\Administrateur\my.cnf" -h $server -D $database -e "$query" -B > $outputFileAD
"@
# execute commande
Invoke-Expression -Command $mysqlCommand

# get content dans le fichier ad (ecrase celui avant)
$results = Get-Content -Path $outputFileAD

# module AD
Import-Module ActiveDirectory

# generataion mdp avec Tecc
function Generate-Password {
    $Prefix = "Tecc"
    $Symbols = @('!', '@', '#', '$', '%', '^', '&', '*')

    # 4 chiffres
    $quatreNumRandom = Generate-RandomNumbers

    # symbole aleatoire
    $symbol = Generate-RandomSymbol

    # placemen avant ou apres 4 chiffres
    $motDePasseSansPrefix = Place-SymbolBeforeOrAfterNumbers $quatreNumRandom $symbol

    # mdp final
    $mdpFinal = $Prefix + $motDePasseSansPrefix

    return $mdpFinal
}

# 4 chiffres 
function Generate-RandomNumbers {
    $random = New-Object System.Random
    $numbers = [string]($random.Next(10000) % 10000) 
    return $numbers.PadLeft(4, '0')  
}

# symbole random
function Generate-RandomSymbol {
    $Symbols = @('!', '@', '#', '$', '%', '^', '&', '*')
    $random = New-Object System.Random
    $index = $random.Next($Symbols.Length)
    return $Symbols[$index]
}

# apres ou avant
function Place-SymbolBeforeOrAfterNumbers {
    param(
        [string]$quatreNumRandom,
        [string]$symbol
    )

    $random = New-Object System.Random
    $k = $random.Next(2) -eq 0  

    if ($k) {
        return "$symbol$quatreNumRandom"
    } else {
        return "$quatreNumRandom$symbol"
    }
}

#sstock info compte cree
$accountsInfo = @()

# chauqe prof, on cree un ADprof et on enleve premiere ligne, sera les champs
foreach ($line in $results[1..$($results.Count-1)]) {
    $fields = $line -split "\t"

    $idProf = $fields[0].Trim()
    $prenomProf = $fields[1].Trim().ToLower()
    $nomProf = $fields[2].Trim().ToLower()
    $departement = $fields[3].Trim().ToLower()

    $username = ($prenomProf[0] + $nomProf).ToLower()
    $password = Generate-Password

    New-ADUser -Name $prenomProf `
               -GivenName $prenomProf `
               -Surname $nomProf `
               -SamAccountName $username `
               -UserPrincipalName "$username@domain.local" `
               -AccountPassword (ConvertTo-SecureString $password -AsPlainText -Force) `
               -Enabled $true `
               -Path "OU=_PROFS,DC=domain,DC=local"

    #dans le tableau pr le mettre dans output
    $accountInfo = "Utilisateur : $username | Mot de passe : $password"
    $accountsInfo += $accountInfo

    # finir par supprimer ce qu il se trouve dans la db
    $deleteQuery = "DELETE FROM prof WHERE true;"
    $mysqlDeleteCommand = @"
    mysql --defaults-file="C:\Users\Administrateur\my.cnf" -h $server -D $database -e "$deleteQuery" 
"@
    Invoke-Expression -Command $mysqlDeleteCommand
}

# dans le output avec le tableau
$accountsInfo | Out-File -FilePath $outputFileCreated -Encoding UTF8
Write-Host "Les informations des comptes créés ont été enregistrées dans : $outputFileCreated"
